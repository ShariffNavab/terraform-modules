name: 'Terraform Apply - Dev'

on:
  workflow_dispatch:  # Manual trigger only
  # push:
  #   branches: [ main ]
  #   paths:
  #     - 'environments/dev/**'

permissions:
  contents: read
  pull-requests: write

env:
  TF_WORKING_DIR: 'environments/dev'

jobs:
  terraform-apply:
    name: 'Terraform Apply'
    runs-on: ubuntu-latest
    environment: dev

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.sha }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init
      run: terraform init
      working-directory: ${{ env.TF_WORKING_DIR }}
      env:
        ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID_DEV }}
        ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

    - name: Terraform Plan
      run: terraform plan -out=terraform.tfplan
      working-directory: environments/dev
      env:
        ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID_DEV }}
        ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}


    - name: Terraform Apply
      run: terraform apply -input=false -auto-approve terraform.tfplan
      working-directory: ${{ env.TF_WORKING_DIR }}
      env:
        ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID_DEV }}
        ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

    - name: Get Terraform Outputs
      id: outputs
      run: |
        # Try to get outputs with proper authentication
        if terraform output -json > /tmp/tf_outputs.json 2>/dev/null; then
          echo "RESOURCE_GROUPS<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/tf_outputs.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "RESOURCE_GROUPS={\"message\": \"No outputs available or failed to fetch\"}" >> $GITHUB_OUTPUT
        fi
      working-directory: ${{ env.TF_WORKING_DIR }}
      env:
        ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      continue-on-error: true

    - name: Create Deployment Summary
      run: |
        echo "## ðŸš€ Terraform Apply Completed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Deployment Summary:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** âœ… Applied successfully" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** dev" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Only show outputs if they exist and are valid
        OUTPUTS='${{ steps.outputs.outputs.RESOURCE_GROUPS }}'
        if [[ "$OUTPUTS" != "{\"message\": \"No outputs available or failed to fetch\"}" ]] && \
          [[ "$OUTPUTS" != "{}" ]]; then
          echo "### ðŸ“Š Terraform Outputs:" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo "$OUTPUTS" | jq '.' 2>/dev/null || echo "$OUTPUTS" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "### â„¹ï¸ Note:" >> $GITHUB_STEP_SUMMARY
          echo "No Terraform outputs were defined in this configuration." >> $GITHUB_STEP_SUMMARY
        fi